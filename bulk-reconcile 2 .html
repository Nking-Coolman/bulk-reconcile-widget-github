<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bulk Invoice Reconciliation — Premium</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--primary-color:#2563eb;--secondary-color:#1e40af;--success-color:#10b981}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f9fafb;color:#111}
    .premium-section{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px;border-radius:8px;margin-top:24px}
    .premium-badge{display:inline-block;background:rgba(255,255,255,0.12);padding:6px 12px;border-radius:16px;font-weight:600}
    .premium-title{font-size:1.8rem;font-weight:700;margin-top:12px}
    .excel-grid{background:white;border-radius:8px;padding:20px;margin-top:20px;color:#1f2937}
    .excel-grid table{width:100%;border-collapse:collapse}
    .excel-grid th{background:#f3f4f6;padding:10px;border:1px solid #e5e7eb}
    .excel-grid td{padding:8px;border:1px solid #e5e7eb}
    .premium-locked{text-align:center;padding:30px;background:white;border-radius:8px}
    .lock-icon{font-size:2.2rem;margin-bottom:8px;opacity:0.6}
    .grid-controls{margin-top:12px;display:flex;justify-content:space-between;align-items:center}
    .custom-toast{background:rgba(17,24,39,0.95);color:#fff;padding:10px 14px;border-radius:8px}
    .matched{background-color:#d1fae5}
    .btn-hero{background:white;color:var(--primary-color);font-weight:600;padding:8px 18px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <section class="cta-section mt-4">
      <div class="p-3 bg-light rounded d-flex align-items-center justify-content-between">
        <div>
          <h3 class="mb-0">Bulk Invoice Reconciliation</h3>
          <div class="text-muted">Process up to 100 invoices locally to match a payment amount.</div>
        </div>
        <div>
          <button class="btn btn-hero">⬇️ Download Code</button>
        </div>
      </div>
    </section>

    <section class="premium-section">
      <div class="premium-badge">✨ Premium Feature</div>
      <div class="premium-title">Bulk Invoice Reconciliation</div>
      <div class="premium-subtitle">Upload and process up to 100 invoices in a single operation</div>

      <div id="premiumContent"></div>
    </section>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Helper: show small toast
    function showToast(message,duration=2500){
      let c=document.getElementById('toastContainer');
      if(!c){c=document.createElement('div');c.id='toastContainer';c.style.position='fixed';c.style.top='16px';c.style.right='16px';c.style.zIndex=1080;document.body.appendChild(c)}
      const t=document.createElement('div');t.className='custom-toast mb-2';t.textContent=message;c.appendChild(t);
      setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(-8px)';},duration-300);
      setTimeout(()=>{t.remove(); if(c.childElementCount===0) c.remove();},duration+100);
    }

    // Subset-sum solver (paired values to original indices)
    function findSubsetsPaired(paired, target, tol, maxResults){
      const results=[];
      paired.sort((a,b)=>b.v-a.v);
      function backtrack(start,sum,path){
        if(results.length>=maxResults) return;
        if(Math.abs(sum-target)<=tol && path.length>0){ results.push(path.slice()); return; }
        if(sum>target+tol) return;
        for(let i=start;i<paired.length;i++){
          if(i>start && paired[i].v===paired[i-1].v) continue;
          path.push(paired[i].i);
          backtrack(i+1,sum+paired[i].v,path);
          path.pop();
        }
      }
      backtrack(0,0,[]);
      return results;
    }

    // Render the premium grid (100 rows)
    function renderPremiumGrid(rowCount=100){
      const premiumContent=document.getElementById('premiumContent');
      let html=`<div class="excel-grid">
        <div class="mb-3 pb-3" style="border-bottom:2px solid #e5e7eb;">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Payment Amount to Match</label>
              <input id="premiumPaymentAmount" class="form-control" type="number" step="0.01" min="0" placeholder="e.g., 15000.00">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tolerance (± $)</label>
              <input id="premiumTolerance" class="form-control" type="number" step="0.01" min="0" value="0.00">
            </div>
          </div>
          <div class="mt-3"><button class="btn btn-primary w-100" id="processBtn">Process ${rowCount} Invoices</button></div>
        </div>
        <div id="premiumResultsContainer" class="mb-3"></div>

        <div class="mb-3">
          <label class="form-label">Enter Invoice Data</label>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="p-2" style="background:rgba(0,0,0,0.02);border-radius:6px">
                <label class="form-label">Import Invoice Amounts</label>
                <textarea id="premiumPasteArea" class="form-control" placeholder="Paste amounts (one per line)" style="height:100px;font-family:monospace"></textarea>
                <div class="mt-2"><button class="btn btn-sm btn-light" id="importAmountsBtn">Import Amounts</button> <button class="btn btn-sm btn-outline-secondary" id="clearPasteAmounts">Clear</button></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-2" style="background:rgba(0,0,0,0.02);border-radius:6px">
                <label class="form-label">Import Invoice IDs</label>
                <textarea id="premiumPasteAreaIds" class="form-control" placeholder="Paste IDs (one per line)" style="height:100px;font-family:monospace"></textarea>
                <div class="mt-2"><button class="btn btn-sm btn-light" id="importIdsBtn">Import IDs</button> <button class="btn btn-sm btn-outline-secondary" id="clearPasteIds">Clear</button> <button class="btn btn-sm btn-secondary" id="resetGridBtn">Reset Grid</button></div>
              </div>
            </div>
          </div>
        </div>

        <div style="overflow:auto;max-height:420px;border-radius:6px;background:white;padding:8px;">
          <table class="table table-sm mb-0">
            <thead class="table-light sticky-top"><tr><th style="width:60px;">#</th><th>Invoice ID</th><th style="width:180px;">Amount ($)</th></tr></thead>
            <tbody id="excelGridBody">
`;
      for(let i=1;i<=rowCount;i++){
        html += `<tr><td class="align-middle text-center" style="font-weight:600">${i}</td><td><input type="text" class="form-control premium-invoice-id" id="premium_id_${i}" data-index="${i-1}" placeholder="INV-${i}"></td><td><input type="number" step="0.01" min="0" class="form-control premium-invoice-amt" id="premium_amt_${i}" data-index="${i-1}" placeholder="0.00"></td></tr>`;
      }
      html += `</tbody></table></div>

      <div class="grid-controls"><span>Total Rows: ${rowCount}</span><div><button class="btn btn-sm btn-outline-secondary" id="clearAllBtn">Clear All</button></div></div>
      </div>`;
      premiumContent.innerHTML = html;

      // wire up buttons
      document.getElementById('processBtn').addEventListener('click', processPremiumInvoices);
      document.getElementById('importAmountsBtn').addEventListener('click', importExcelData);
      document.getElementById('importIdsBtn').addEventListener('click', importExcelIds);
      document.getElementById('clearPasteAmounts').addEventListener('click', ()=>{document.getElementById('premiumPasteArea').value='';});
      document.getElementById('clearPasteIds').addEventListener('click', ()=>{document.getElementById('premiumPasteAreaIds').value='';});
      document.getElementById('resetGridBtn').addEventListener('click', resetPremiumState);
      document.getElementById('clearAllBtn').addEventListener('click', clearPremiumGrid);

      function importBulkExcelData() {
        const txt = document.getElementById('bulkExcelPasteArea').value.trim();
        if (!txt) {
          showToast('Paste Excel data first');
          return;
        }

        const rows = txt.split('\n').map(row => row.split('\t'));
        let filled = 0;

        rows.forEach((cols, idx) => {
          if (cols.length >= 2) {
            const id = cols[0].trim();
            const amt = parseFloat(cols[1].replace(/[$,\s]/g, '').trim());

            if (!isNaN(amt) && amt > 0) {
              const idField = document.getElementById(`premium_id_${idx + 1}`);
              const amtField = document.getElementById(`premium_amt_${idx + 1}`);

              if (idField && amtField) {
                idField.value = id;
                amtField.value = amt.toFixed(2);
                filled++;
              }
            }
          }
        });

        showToast(`Imported ${filled} row(s)`);
        document.getElementById('bulkExcelPasteArea').value = '';
      }
    }

    function processPremiumInvoices(){
      const paymentAmount = parseFloat(document.getElementById('premiumPaymentAmount').value||'0');
      const tolerance = parseFloat(document.getElementById('premiumTolerance').value||'0');
      if(!paymentAmount || paymentAmount<=0){ showToast('Enter a payment amount to match'); return; }
      const invoiceIds=[]; const invoiceAmts=[];
      document.querySelectorAll('.premium-invoice-id').forEach((el,idx)=>invoiceIds.push(el.value||`Invoice ${idx+1}`));
      document.querySelectorAll('.premium-invoice-amt').forEach(el=>{const v=parseFloat(el.value)||0;invoiceAmts.push(v);});
      const filled = invoiceAmts.filter(v=>v>0).length; if(filled===0){ showToast('Enter at least one invoice amount'); return; }
      const cents = invoiceAmts.map(v=>Math.round(v*100));
      const paymentCents = Math.round(paymentAmount*100); const tolCents = Math.round(tolerance*100);
      const paired = cents.map((v,i)=>({v,i})).filter(p=>p.v>0);
      const subsets = findSubsetsPaired(paired,paymentCents,tolCents,50);
      if(subsets.length===0){ showToast(`No matches for $${paymentAmount.toFixed(2)} ± $${tolerance.toFixed(2)}`); document.getElementById('premiumResultsContainer').innerHTML=''; return; }

      // build results
      let html = `<div style="background:white;padding:12px;border-radius:8px">`;
      html += `<h5 style="color:${'#10b981'};">Found ${subsets.length} combination(s)</h5>`;
      subsets.forEach((set,idx)=>{
        const matchAmount = set.reduce((s,i)=>s+invoiceAmts[i],0);
        const diff = Math.abs(matchAmount-paymentAmount);
        const amounts = set.map(i=>`$${invoiceAmts[i].toFixed(2)}`).join(' + ');
        const invoiceDetails = set.map(i=>`${invoiceIds[i]||`Invoice ${i+1}`}: $${invoiceAmts[i].toFixed(2)}`).join('<br>');
        html += `<div style="background:#f3f4f6;padding:10px;border-radius:6px;margin-bottom:8px;">`;
        html += `<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px"><div style="flex:1"><strong>Combination ${idx+1}:</strong><div style="font-family:monospace;margin-top:6px">${amounts}</div><div style="margin-top:6px;font-weight:600">= $${matchAmount.toFixed(2)}</div><div style="margin-top:6px">${invoiceDetails}</div><div style="margin-top:6px">Difference: $${diff.toFixed(2)}</div></div><div class="btn-group" style="flex-shrink:0"><button class="btn btn-sm btn-outline-success" data-idx="${idx}">Highlight</button></div></div></div>`;
      });
      html += `</div>`;
      document.getElementById('premiumResultsContainer').innerHTML = html;
      // wire highlight buttons
      document.querySelectorAll('#premiumResultsContainer .btn-outline-success').forEach((b,bi)=>{
        b.addEventListener('click',()=>{
          const html = document.getElementById('premiumResultsContainer').innerHTML;
          // parse indices from the corresponding subset (we re-run find to get current subsets)
          const newSubsets = findSubsetsPaired(paired,paymentCents,tolCents,50);
          const chosen = newSubsets[bi]||[]; highlightPremiumInvoices(chosen);
        });
      });
    }

    function highlightPremiumInvoices(indices){
      document.querySelectorAll('.premium-invoice-amt').forEach(el=>{el.classList.remove('matched');el.style.border='';el.style.background='';});
      indices.forEach(i=>{ const el=document.getElementById(`premium_amt_${i+1}`); if(el){ el.classList.add('matched'); el.style.background='#d1fae5'; el.style.border='2px solid #10b981'; }});
      if(indices.length>0){ const first=document.getElementById(`premium_amt_${indices[0]+1}`); if(first) first.scrollIntoView({behavior:'smooth',block:'nearest'}); }
    }

    function clearPremiumGrid(){ document.querySelectorAll('.premium-invoice-id, .premium-invoice-amt').forEach(el=>el.value=''); }

    function resetPremiumState(){ clearPremiumGrid(); const rc=document.getElementById('premiumResultsContainer'); if(rc) rc.innerHTML=''; document.querySelectorAll('.premium-invoice-amt, .premium-invoice-id').forEach(el=>{el.classList.remove('matched');el.style.boxShadow='';el.style.border='';el.style.background='';}); }

    function importExcelData(){
      const txt=document.getElementById('premiumPasteArea').value.trim(); if(!txt){ showToast('Paste amounts first'); return; }
      const lines=txt.split('\n').map(l=>l.trim()).filter(Boolean);
      let filled=0; lines.forEach((ln,idx)=>{ const cleaned=ln.replace(/[$,\s]/g,'').trim(); const amt=parseFloat(cleaned); if(!isNaN(amt) && amt>0){ const el=document.getElementById(`premium_amt_${idx+1}`); if(el){ el.value=amt.toFixed(2); filled++; }}});
      showToast(`Imported ${filled} amount(s)`);
      document.getElementById('premiumPasteArea').value='';
    }

    function importExcelIds(){
      const txt=document.getElementById('premiumPasteAreaIds').value.trim(); if(!txt){ showToast('Paste IDs first'); return; }
      const lines=txt.split('\n').map(l=>l.trim()).filter(Boolean); let filled=0; lines.forEach((ln,idx)=>{ const el=document.getElementById(`premium_id_${idx+1}`); if(el){ el.value=ln; filled++; }}); showToast(`Imported ${filled} ID(s)`); document.getElementById('premiumPasteAreaIds').value='';
    }

    document.addEventListener('DOMContentLoaded',()=>{ renderPremiumGrid(100); });
  </script>
</body>
</html>